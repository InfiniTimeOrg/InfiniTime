# Internationalization

## Tool

InfiniTime is internationalized using [lv_i18n](https://github.com/lvgl/lv_i18n).

## English

As lv_i18n falls back to display the passed string if no translation could be found, the english phrase is used as key. As a result, in the `en.yml` file, there is no translation, marked with `~`. This saves a little bit of precious flash space. The only exception is, when two phrases need to be translated differently in some languages, but to the same phrase in english. In this case, the english translation has a valid entry.

## Add a new language

The easiest way is to copy the en.yml file. As name and first line, pick the ISO 639-1 two letter id of the language. Then, go ahead and translate the individual phrases. If you do not know or there is no suitable phrase in the chosen language, you can leave it as is to fall back to english. If there is a phrase which can not be translated because of its format, either change the corresponding code so that it fits both english as well as the new language. Or, if you do not feel comfortable changing the code, open a new issue where you report your problem.

## Add a new translated phrase in code

You can change an existing occurence of a C string to be translated by replacing `"some string"` with `_("some string")`. The extractor will then pick it up and add it into the yml files.

If the string is used in a `constexp`, the above will not work, as the function `_()` is not `constexp`. In this case, change the point at which the `constexp`variable is actually use, eg for setting a label, and surround it with `_()`. Finally, the actual string needs to be used once by `_()` to be picked up by lv_i18n's extractor. For this, it is enough to wrap calls into an `#if 0` block. This block will be read by the extractor, but removed by the precompiler.

For (a constructed) example, this:

```C++
static constexpr SomeType element {1, "some text", 12};

void function() {
    lv_label_set_text_static(title, element.title);
}
```

will become

```C++
//to let lv_i18n extractor find the strings
#if 0
    _("some text");
#endif

static constexpr SomeType element {1, "some text", 12};

void function() {
    lv_label_set_text_static(title, _(element.title));
}
```

## Extracting phrases

As show in the lv_i18n documentation, to extract the phrases, run

```sh
lv_i18n extract -s 'src/**/*.+(cpp|h)' -t 'translation/*.yml'
```

Note that the `**` syntax is not supported by all shells. For example, in bash, you need to enable it with `shopt -s globstar`.

## Generating translations

As show in the lv_i18n documentation, to generate the translations, run

```sh
lv_i18n compile -l 'en' -t 'translation/*.yml' -o src/lv_i18n/
```

Here, one problem exists with the current version of lv_i18n. Occurences of `\n` are written `\\n` in the generated C file which breaks the lookup as well as the display of the phrases. To fix this, replace `\\n` with `\n` or use the following sed line:

```sh
sed -i 's/\\\\/\\/g' src/lv_i18n/lv_i18n.c
```

## UTF-8

InfiniTime does not support UTF-8 based characters at this time. Those characters will either not be displayed or break the rendering of the phrase. So, for now you need to transliterate your language to ASCII.
